#Port auslesen über die PowerShell - Windows Betriebsystem
# Konfiguration
$comPort = "COMx"           # COM Port über Gerätemanager ermitteln und x ändern
$baudRate = 115200          
$k=0    # variable für while Schleife
$m=10   # variable für Anzahl der Messsungen

$logFile = "C:\temp\daten_BlackBox.txt"  # Hier Daten speichern (kann auch in .csv speichern - Endung Aendern

# Port öffnen
$port = New-Object System.IO.Ports.SerialPort $comPort, $baudRate, 'None', 8, 'One'
$port.ReadTimeout = 777
$port.Open()

# Log-Datei vorbereiten in C\temp
if (!(Test-Path $logFile)) {
    "Datum Uhrzeit, Wert von Black Box" | Out-File -Encoding UTF8 $logFile
}

Write-Host "Daten von $comPort. Drücke STRG+C zum Beenden.`n"  #Ausgabe in PowerShell

# Endlosschleife zum Lesen der Daten

try {
    while ($k -lt $m) {
        try {
            $line = $port.ReadLine().Trim()
            if ($line -match '^\d+$') {
                $intVal = [int]$line
                $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
                Write-Host "$timestamp - Empfangener Wert: : $intVal       ......    STRG+C zum Beenden.`n"
                $k++
                "$timestamp, $intVal" | Out-File -Append -Encoding UTF8 $logFile  
            } else {
                Write-Warning "Ungültige Zeile: '$line'"
            }
        } catch {
            # Timeout oder Lesefehler ignorieren
        }
          
    }
}
finally {
    $port.Close()
    Write-Host "`n Ende. Verbindung zu $comPort geschlossen."
}
